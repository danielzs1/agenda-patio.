<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Administración</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Panel de Administración</h1>
  <button onclick="exportarExcel()">Exportar a Excel</button>
  <div>
    <label for="fechaFiltro">Filtrar por fecha: </label>
    <input type="date" id="fechaFiltro" onchange="filtrarPorFecha()">
  </div>
  <ul id="lista-citas"></ul>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, deleteDoc, doc, query, where
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAGpefaI4KKoUzKbmAUp_QHH1QCJJon6Dg",
      authDomain: "agendapatio-bd75e.firebaseapp.com",
      projectId: "agendapatio-bd75e",
      storageBucket: "agendapatio-bd75e.appspot.com",
      messagingSenderId: "2629668570",
      appId: "1:2629668570:web:13ac210ecf525e09a99fe3",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const citasRef = collection(db, "citas");

    let todasLasCitas = [];

    async function cargarCitas() {
      const querySnapshot = await getDocs(citasRef);
      todasLasCitas = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      mostrarCitas(todasLasCitas);
    }

    function mostrarCitas(citas) {
      const lista = document.getElementById("lista-citas");
      lista.innerHTML = "";

      citas.forEach(cita => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${cita.nombre}</strong> -
          Fecha: ${cita.fecha} -
          Franja: ${cita.franja} -
          Hora: ${cita.hora} -
          Placa: ${cita.placa} -
          Transportadora: ${cita.transportadora} -
          Conductor: ${cita.conductor} 
          <button onclick="eliminarCita('${cita.id}')">Eliminar</button>
        `;
        lista.appendChild(li);
      });
    }

    window.eliminarCita = async function(id) {
      const confirmacion = confirm("¿Estás seguro que deseas eliminar esta cita?");
      if (confirmacion) {
        await deleteDoc(doc(db, "citas", id));
        cargarCitas();
      }
    }

    window.exportarExcel = function() {
      const wsData = [
        ["Nombre", "Fecha", "Franja", "Hora", "Placa", "Transportadora", "Conductor"]
      ];
      todasLasCitas.forEach(cita => {
        wsData.push([
          cita.nombre,
          cita.fecha,
          cita.franja,
          cita.hora,
          cita.placa,
          cita.transportadora,
          cita.conductor
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Citas");
      XLSX.writeFile(wb, "citas.xlsx");
    }

    window.filtrarPorFecha = function() {
      const fechaSeleccionada = document.getElementById("fechaFiltro").value;
      if (!fechaSeleccionada) return mostrarCitas(todasLasCitas);
      const filtradas = todasLasCitas.filter(c => c.fecha === fechaSeleccionada);
      mostrarCitas(filtradas);
    }

    cargarCitas();
  </script>
</body>
</html>
